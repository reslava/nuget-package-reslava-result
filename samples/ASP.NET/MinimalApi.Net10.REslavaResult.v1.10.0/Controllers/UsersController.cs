using Microsoft.AspNetCore.Mvc;
using REslava.Result.AdvancedPatterns;  // ðŸ†• v1.10.0: REslava.Result's internal OneOf
using REslava.Result;
using MinimalApi.Net10.REslavaResult.Models;
using Generated.ResultExtensions;  // Auto-generated by v1.10.0
using Generated.OneOfExtensions;  // Auto-generated by v1.10.0

namespace MinimalApi.Net10.REslavaResult.Controllers;

/// <summary>
/// ðŸ†• v1.10.0: Test controller demonstrating REslava.Result's internal OneOf integration with SourceGenerators.
/// Shows the revolutionary breakthrough: internal OneOf + REslava.Result generators working together!
/// </summary>
[ApiController]
[Route("api/[controller]")]
public class UsersController : ControllerBase
{
    private static readonly List<User> _users = new();

    static UsersController()
    {
        // Add test data for integration tests
        _users.Add(new User { Id = 1, Name = "Test User", Email = "test@example.com", CreatedAt = DateTime.UtcNow });
    }

    /// <summary>
    /// ðŸ†• v1.10.0: Gets a user by ID using REslava.Result's internal OneOf.
    /// Returns OneOf of UserNotFoundError and User.
    /// Auto-converts to HTTP response by OneOf2ToIResult generator!
    /// </summary>
    [HttpGet("{id}")]
    public OneOf<UserNotFoundError, User> GetUser(int id)
    {
        var user = _users.FirstOrDefault(u => u.Id == id);
        if (user == null)
        {
            return new UserNotFoundError(id);
        }

        return user;
    }

    /// <summary>
    /// ðŸ†• v1.10.0: Creates a new user using REslava.Result's internal OneOf.
    /// Returns OneOf of ValidationError and User.
    /// Auto-converts to HTTP response by OneOf2ToIResult generator!
    /// </summary>
    [HttpPost]
    public OneOf<ValidationError, User> CreateUser([FromBody] CreateUserRequest request)
    {
        // Validate input
        if (string.IsNullOrWhiteSpace(request.Name))
        {
            return new ValidationError("Name", "Name is required");
        }

        if (string.IsNullOrWhiteSpace(request.Email) || !request.Email.Contains("@"))
        {
            return new ValidationError("Email", "Valid email is required");
        }

        // Check for duplicate email
        if (_users.Any(u => u.Email.Equals(request.Email, StringComparison.OrdinalIgnoreCase)))
        {
            return new ValidationError("Email", "Email already exists");
        }

        // Create user
        var user = new User
        {
            Id = _users.Count + 1,
            Name = request.Name,
            Email = request.Email,
            CreatedAt = DateTime.UtcNow
        };

        _users.Add(user);

        return user;
    }

    /// <summary>
    /// ðŸ†• v1.10.0: Demonstrates the magic: REslava.Result OneOf â†’ IResult conversion
    /// This method uses the auto-generated ToIResult() extension method from OneOf2ToIResult generator
    /// </summary>
    [HttpGet("{id}/result")]
    public IResult GetUserAsResult(int id)
    {
        // ðŸª„ v1.10.0 MAGIC: Auto-converts REslava.Result OneOf to HTTP response:
        // - UserNotFoundError â†’ 400 Bad Request (first type in OneOf)
        // - User â†’ 200 OK with user data (second type in OneOf)
        return GetUser(id).ToIResult();
    }

    /// <summary>
    /// ðŸ†• v1.10.0: Demonstrates the magic: REslava.Result OneOf â†’ IResult conversion for POST
    /// This method uses the auto-generated ToIResult() extension method from OneOf2ToIResult generator
    /// </summary>
    [HttpPost("result")]
    public IResult CreateUserAsResult([FromBody] CreateUserRequest request)
    {
        // ðŸª„ v1.10.0 MAGIC: Auto-converts REslava.Result OneOf to HTTP response:
        // - ValidationError â†’ 400 Bad Request (first type in OneOf)
        // - User â†’ 200 OK with user data (second type in OneOf)
        return CreateUser(request).ToIResult();
    }

    /// <summary>
    /// ðŸ†• v1.10.0: Tests T1,T2,T3 OneOf implementation using REslava.Result's internal OneOf.
    /// Returns OneOf of ValidationError, NotFoundError, and User.
    /// Auto-converts to HTTP response by OneOf3ToIResult generator!
    /// </summary>
    [HttpPut("{id}")]
    public OneOf<ValidationError, UserNotFoundError, User> UpdateUser(int id, [FromBody] CreateUserRequest request)
    {
        // Validate input
        if (string.IsNullOrWhiteSpace(request.Name))
        {
            return new ValidationError("Name", "Name is required");
        }

        if (string.IsNullOrWhiteSpace(request.Email) || !request.Email.Contains("@"))
        {
            return new ValidationError("Email", "Valid email is required");
        }

        // Find user
        var user = _users.FirstOrDefault(u => u.Id == id);
        if (user == null)
        {
            return new UserNotFoundError(id);
        }

        // Update user
        user.Name = request.Name;
        user.Email = request.Email;
        user.UpdatedAt = DateTime.UtcNow;

        // Return success
        return user;
    }

    /// <summary>
    /// ðŸ†• v1.10.0: Demonstrates the magic: T1,T2,T3 REslava.Result OneOf â†’ IResult conversion
    /// This method uses the auto-generated ToIResult() extension method from OneOf3ToIResult generator
    /// </summary>
    [HttpPut("{id}/result")]
    public IResult UpdateUserAsResult(int id, [FromBody] CreateUserRequest request)
    {
        // ðŸª„ v1.10.0 MAGIC: Auto-converts REslava.Result OneOf to HTTP response:
        // - ValidationError â†’ 400 Bad Request (first type in OneOf)
        // - UserNotFoundError â†’ 400 Bad Request (second type in OneOf)
        // - User â†’ 200 OK with updated user data (third type in OneOf)
        return UpdateUser(id, request).ToIResult();
    }

    /// <summary>
    /// ðŸ†• v1.10.0: Demonstrates Result<T> + OneOf working together!
    /// Shows both REslava.Result patterns working in the same project.
    /// </summary>
    [HttpGet("{id}/hybrid")]
    public Result<User> GetUserResult(int id)
    {
        var user = _users.FirstOrDefault(u => u.Id == id);
        if (user == null)
        {
            return Result<User>.Fail(new UserNotFoundError(id));
        }

        return Result<User>.Ok(user);
    }

    /// <summary>
    /// ðŸ†• v1.10.0: Hybrid example - Result<T> auto-conversion
    /// Shows ResultToIResult generator working alongside OneOf generators
    /// </summary>
    [HttpGet("{id}/hybrid/result")]
    public IResult GetUserResultAsResult(int id)
    {
        // ðŸª„ Result<T> MAGIC: Auto-converts Result<T> to HTTP response:
        // - UserNotFoundError â†’ 404 Not Found (smart error classification)
        // - User â†’ 200 OK with user data
        return GetUserResult(id).ToIResult();
    }
}

/// <summary>
/// Request model for creating users.
/// </summary>
public class CreateUserRequest
{
    public string Name { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
}
