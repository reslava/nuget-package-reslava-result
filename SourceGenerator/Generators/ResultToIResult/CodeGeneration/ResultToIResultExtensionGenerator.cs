using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using REslava.Result.SourceGenerators.Generators.ResultToIResult.Interfaces;
using System.Text;

namespace REslava.Result.SourceGenerators.Generators.ResultToIResult.CodeGeneration
{
    /// <summary>
    /// Generates ResultToIResult extension methods.
    /// Single Responsibility: Only generates the main extension methods.
    /// </summary>
    public class ResultToIResultExtensionGenerator : ICodeGenerator
    {
        public SourceText GenerateCode(Compilation compilation, object config)
        {
            // Basic implementation with HTTP method extensions that test code expects
            var source = @"
using Microsoft.AspNetCore.Http;
using REslava.Result;
using System.Linq;

namespace Generated.ResultExtensions
{
    /// <summary>
    /// Extension methods for converting Result&lt;T&gt; to IResult.
    /// Generated by REslava.Result.SourceGenerators.
    /// </summary>
    public static class ResultToIResultExtensions
    {
        /// <summary>
        /// Converts a Result&lt;T&gt; to an IResult for ASP.NET Core responses.
        /// </summary>
        public static IResult ToIResult<T>(this Result<T> result)
        {
            if (result.IsSuccess)
            {
                return Results.Ok(result.Value);
            }

            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? ""Unknown error"";
            return Results.Problem(
                detail: errorMessage,
                statusCode: 400
            );
        }

        /// <summary>
        /// Converts a Result&lt;T&gt; to a POST result.
        /// </summary>
        public static IResult ToPostResult<T>(this Result<T> result)
        {
            if (result.IsSuccess)
            {
                return Results.Created($""/api/items"", result.Value);
            }

            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? ""Unknown error"";
            return Results.Problem(
                detail: errorMessage,
                statusCode: 400
            );
        }

        /// <summary>
        /// Converts a Result&lt;T&gt; to a PUT result.
        /// </summary>
        public static IResult ToPutResult<T>(this Result<T> result)
        {
            if (result.IsSuccess)
            {
                return Results.Ok(result.Value);
            }

            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? ""Unknown error"";
            return Results.Problem(
                detail: errorMessage,
                statusCode: 400
            );
        }

        /// <summary>
        /// Converts a Result&lt;T&gt; to a PATCH result.
        /// </summary>
        public static IResult ToPatchResult<T>(this Result<T> result)
        {
            if (result.IsSuccess)
            {
                return Results.Ok(result.Value);
            }

            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? ""Unknown error"";
            return Results.Problem(
                detail: errorMessage,
                statusCode: 400
            );
        }

        /// <summary>
        /// Converts a Result&lt;T&gt; to a DELETE result.
        /// </summary>
        public static IResult ToDeleteResult<T>(this Result<T> result)
        {
            if (result.IsSuccess)
            {
                return Results.NoContent();
            }

            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? ""Unknown error"";
            return Results.Problem(
                detail: errorMessage,
                statusCode: 400
            );
        }
    }
}";

            return SourceText.From(source, Encoding.UTF8);
        }
    }
}
