using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using REslava.Result.SourceGenerators.Generators.ResultToIResult.Interfaces;
using System.Text;

namespace REslava.Result.SourceGenerators.Generators.ResultToIResult.CodeGeneration
{
    /// <summary>
    /// Generates ResultToIResult extension methods.
    /// Single Responsibility: Only generates the main extension methods.
    /// </summary>
    public class ResultToIResultExtensionGenerator : ICodeGenerator
    {
        public SourceText GenerateCode(Compilation compilation, object config)
        {
            var builder = new StringBuilder();
            
            // Add using statements
            builder.AppendLine("using Microsoft.AspNetCore.Http;");
            builder.AppendLine("using REslava.Result;");
            builder.AppendLine("using System.Linq;");
            builder.AppendLine("using Generated.ResultExtensions;");
            builder.AppendLine();
            
            // Generate the class and methods
            builder.AppendLine("namespace Generated.ResultExtensions");
            builder.AppendLine("{");
            builder.AppendLine("    /// <summary>");
            builder.AppendLine("    /// Extension methods for converting Result&lt;T&gt; to IResult.");
            builder.AppendLine("    /// Generated by REslava.Result.SourceGenerators.");
            builder.AppendLine("    /// </summary>");
            builder.AppendLine("    public static class ResultToIResultExtensions");
            builder.AppendLine("    {");
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to an IResult for ASP.NET Core responses.");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IResult ToIResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("            {");
            builder.AppendLine("                return Results.Ok(result.Value);");
            builder.AppendLine("            }");
            builder.AppendLine();
            builder.AppendLine("            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? \"Unknown error\";");
            builder.AppendLine("            return Results.Problem(");
            builder.AppendLine("                detail: errorMessage,");
            builder.AppendLine("                statusCode: 400");
            builder.AppendLine("            );");
            builder.AppendLine("        }");
            builder.AppendLine();
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to a POST result.");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IResult ToPostResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("            {");
            builder.AppendLine("                return Results.Created($\"/api/items\", result.Value);");
            builder.AppendLine("            }");
            builder.AppendLine();
            builder.AppendLine("            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? \"Unknown error\";");
            builder.AppendLine("            return Results.Problem(");
            builder.AppendLine("                detail: errorMessage,");
            builder.AppendLine("                statusCode: 400");
            builder.AppendLine("            );");
            builder.AppendLine("        }");
            builder.AppendLine();
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to a PUT result.");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IResult ToPutResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("            {");
            builder.AppendLine("                return Results.Ok(result.Value);");
            builder.AppendLine("            }");
            builder.AppendLine();
            builder.AppendLine("            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? \"Unknown error\";");
            builder.AppendLine("            return Results.Problem(");
            builder.AppendLine("                detail: errorMessage,");
            builder.AppendLine("                statusCode: 400");
            builder.AppendLine("            );");
            builder.AppendLine("        }");
            builder.AppendLine();
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to a PATCH result.");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IResult ToPatchResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("            {");
            builder.AppendLine("                return Results.Ok(result.Value);");
            builder.AppendLine("            }");
            builder.AppendLine();
            builder.AppendLine("            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? \"Unknown error\";");
            builder.AppendLine("            return Results.Problem(");
            builder.AppendLine("                detail: errorMessage,");
            builder.AppendLine("                statusCode: 400");
            builder.AppendLine("            );");
            builder.AppendLine("        }");
            builder.AppendLine();
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to a DELETE result.");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IResult ToDeleteResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("            {");
            builder.AppendLine("                return Results.NoContent();");
            builder.AppendLine("            }");
            builder.AppendLine();
            builder.AppendLine("            var errorMessage = result.Errors.FirstOrDefault()?.Message ?? \"Unknown error\";");
            builder.AppendLine("            return Results.Problem(");
            builder.AppendLine("                detail: errorMessage,");
            builder.AppendLine("                statusCode: 400");
            builder.AppendLine("            );");
            builder.AppendLine("        }");
            builder.AppendLine("    }");
            builder.AppendLine("}");

            return SourceText.From(builder.ToString(), Encoding.UTF8);
        }
    }
}
