using Microsoft.CodeAnalysis;
using REslava.Result.SourceGenerators.SmartEndpoints.Orchestration;
using REslava.Result.SourceGenerators.Core.Interfaces;
using REslava.Result.SourceGenerators.Generators.SmartEndpoints.Attributes;
using REslava.Result.SourceGenerators.Generators.SmartEndpoints.CodeGeneration;

namespace REslava.Result.SourceGenerators.Generators.SmartEndpoints
{
    /// <summary>
    /// SmartEndpoints generator - automatically generates ASP.NET Core Minimal API endpoints
    /// from methods returning Result&lt;T&gt; or OneOf&lt;...&gt; types.
    /// Single Responsibility: Only delegates to the orchestrator.
    /// </summary>
    [Generator]
    public class SmartEndpointsGenerator : IIncrementalGenerator
    {
        private readonly IGeneratorOrchestrator? _orchestrator;

        public SmartEndpointsGenerator()
        {
            System.Diagnostics.Debug.WriteLine("üöÄ SmartEndpointsGenerator CONSTRUCTOR called!");
            
            try
            {
                _orchestrator = new SmartEndpointsOrchestrator(
                    new AutoGenerateEndpointsAttributeGenerator(),
                    new AutoMapEndpointAttributeGenerator(),
                    new SmartEndpointExtensionGenerator());
                    
                System.Diagnostics.Debug.WriteLine("‚úÖ SmartEndpointsGenerator initialized successfully!");
            }
            catch (System.Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå SmartEndpointsGenerator constructor failed: {ex}");
                
                // Create a static field to track constructor failure
                ConstructorError = ex.Message;
            }
        }
        
        // Static field to track constructor issues
        public static string? ConstructorError { get; private set; }

        /// <summary>
        /// Initializes the generator pipeline using the orchestrator.
        /// </summary>
        public void Initialize(IncrementalGeneratorInitializationContext context)
        {
            System.Diagnostics.Debug.WriteLine("üöÄ SmartEndpointsGenerator.Initialize called!");
            
            try
            {
                // Force generate a marker file using a simple approach
                context.RegisterSourceOutput(context.CompilationProvider, (spc, compilation) =>
                {
                    var timestamp = DateTime.UtcNow.ToString("O");
                    spc.AddSource("SmartEndpointsInitializeMarker.g.cs", 
$@"// SmartEndpointsGenerator.Initialize called at {timestamp}
// This file proves that SmartEndpoints.Initialize is working!
// Generated by: SmartEndpointsGenerator
// Mode: Debug (File)
// Status: SUCCESS");
                });
                
                // Generate the actual SmartEndpoints extensions in-memory (DISABLED TEST VERSION)
                // context.RegisterSourceOutput(context.CompilationProvider, (spc, compilation) =>
                // {
                //     // Simple test extension to prove in-memory generation works
                //     spc.AddSource("SmartEndpointsTestExtensions.g.cs", 
                // @"// SmartEndpoints Test Extension - In-Memory Generation
                // using Microsoft.AspNetCore.Builder;
                // using Microsoft.AspNetCore.Routing;

                // namespace Generated.SmartEndpoints
                // {
                //     public static class SmartEndpointsTestExtensions
                //     {
                //         public static void MapSmartEndpoints(this IEndpointRouteBuilder endpoints)
                //         {
                //             // Test endpoint to prove SmartEndpoints is working
                //             endpoints.MapGet(""/api/smarttest/test"", () => Results.Ok(new { 
                //                 message = ""SmartEndpoints is working!"", 
                //                 timestamp = DateTime.UtcNow,
                //                 generator = ""SmartEndpoints v1.10.0""
                //             }));
                //         }
                //     }
                // }");
                // });
                
                if (_orchestrator != null)
                {
                    System.Diagnostics.Debug.WriteLine("‚úÖ SmartEndpointsGenerator: Calling orchestrator.Initialize");
                    _orchestrator.Initialize(context);
                    System.Diagnostics.Debug.WriteLine("‚úÖ SmartEndpointsGenerator: orchestrator.Initialize completed");
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå SmartEndpointsGenerator: orchestrator is null");
                    
                    // Generate error file if orchestrator failed to initialize
                    context.RegisterSourceOutput(context.CompilationProvider, (spc, compilation) =>
                    {
                        spc.AddSource("SmartEndpointsConstructorError.g.cs", 
                            $"// SmartEndpointsGenerator constructor failed: {ConstructorError}");
                    });
                }
            }
            catch (System.Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå SmartEndpointsGenerator.Initialize failed: {ex}");
                System.Diagnostics.Debug.WriteLine($"‚ùå Stack trace: {ex.StackTrace}");
                
                // Generate error file to make failure visible
                context.RegisterSourceOutput(context.CompilationProvider, (spc, compilation) =>
                {
                    spc.AddSource("SmartEndpointsInitializeError.g.cs", 
                        $"// SmartEndpointsGenerator.Initialize failed: {ex.Message}\n// Stack trace: {ex.StackTrace}");
                });
            }
        }
    }
}
