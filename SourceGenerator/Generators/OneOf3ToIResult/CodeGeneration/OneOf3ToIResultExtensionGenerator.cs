using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using REslava.Result.SourceGenerators.Core.Interfaces;
using System.Text;

namespace REslava.Result.SourceGenerators.Generators.OneOf3ToIResult.CodeGeneration
{
    /// <summary>
    /// Generates OneOf3ToIResult extension methods.
    /// Single Responsibility: Only generates the main extension methods.
    /// </summary>
    public class OneOf3ToIResultExtensionGenerator : ICodeGenerator
    {
        public SourceText GenerateCode(Compilation compilation, object config)
        {
            System.Diagnostics.Debug.WriteLine("ðŸ”¥ OneOf3ToIResultExtensionGenerator.GenerateCode called!");
            
            var builder = new StringBuilder();
            
            // Add using statements
            builder.AppendLine("using Microsoft.AspNetCore.Http;");
            builder.AppendLine("using REslava.Result.AdvancedPatterns;");
            builder.AppendLine("using System.Linq;");
            builder.AppendLine("using Generated.OneOfExtensions;");
            builder.AppendLine();
            
            // Generate the class and methods
            builder.AppendLine("namespace Generated.OneOfExtensions");
            builder.AppendLine("{");
            builder.AppendLine("    /// <summary>");
            builder.AppendLine("    /// Extension methods for converting OneOf&lt;T1,T2,T3&gt; to IResult.");
            builder.AppendLine("    /// Generated by REslava.Result.SourceGenerators.");
            builder.AppendLine("    /// </summary>");
            builder.AppendLine("    public static class OneOf3Extensions");
            builder.AppendLine("    {");
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts OneOf&lt;T1,T2,T3&gt; to IResult with intelligent HTTP mapping.");
            builder.AppendLine("        /// T1 â†’ 400 (BadRequest), T2 â†’ 400 (BadRequest), T3 â†’ 200 (Ok)");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IResult ToIResult<T1, T2, T3>(this OneOf<T1, T2, T3> oneOf)");
            builder.AppendLine("        {");
            builder.AppendLine("            return oneOf.Match(");
            builder.AppendLine("                t1 => Results.BadRequest(t1?.ToString() ?? \"Error\"),");
            builder.AppendLine("                t2 => Results.BadRequest(t2?.ToString() ?? \"Error\"),");
            builder.AppendLine("                t3 => Results.Ok(t3)");
            builder.AppendLine("            );");
            builder.AppendLine("        }");
            builder.AppendLine("    }");
            builder.AppendLine("}");
            
            var result = SourceText.From(builder.ToString(), Encoding.UTF8);
            System.Diagnostics.Debug.WriteLine("ðŸ”¥ OneOf3ToIResultExtensionGenerator.GenerateCode completed!");
            return result;
        }
    }
}
