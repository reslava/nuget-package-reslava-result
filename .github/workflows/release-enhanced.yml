name: Enhanced Release Pipeline

on:
  push:
    tags:
      - 'v*'

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  # ğŸ” Pre-Release Validation
  pre-release-validation:
    runs-on: ubuntu-latest
    outputs:
      can-release: ${{ steps.validation.outputs.can-release }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Extract Version
        id: version
        run: echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Run Full Test Suite
        run: |
          echo "ğŸ§ª Running comprehensive pre-release tests..."
          dotnet test --configuration Release --logger "trx;LogFileName=test_results.trx"
          
      - name: Validate Version Consistency
        id: validation
        run: |
          echo "ğŸ” Validating version consistency..."
          
          # Check Directory.Build.props
          core_version=$(grep -oP '(?<=<CorePackageVersion>)[^<]+' Directory.Build.props)
          gen_version=$(grep -oP '(?<=<GeneratorPackageVersion>)[^<]+' Directory.Build.props)
          
          echo "Core version: $core_version"
          echo "Generator version: $gen_version"
          echo "Tag version: ${{ github.ref_name }}"
          
          if [[ "$gen_version" == "${{ github.ref_name }}" ]]; then
            echo "âœ… Version consistency validated"
            echo "can-release=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Version mismatch detected"
            echo "can-release=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: '**/*.trx'

  # ğŸ—ï¸ Multi-Framework Build
  build-matrix:
    runs-on: ubuntu-latest
    needs: pre-release-validation
    if: needs.pre-release-validation.outputs.can-release == 'true'
    strategy:
      matrix:
        project: [core, generator]
        framework: [net8.0, net9.0, net10.0]
        include:
          - project: core
            csproj: src/REslava.Result.csproj
            package: REslava.Result
          - project: generator
            csproj: SourceGenerator/REslava.Result.SourceGenerators.csproj
            package: REslava.Result.SourceGenerators
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build ${{ matrix.project }} for ${{ matrix.framework }}
        run: |
          echo "ğŸ—ï¸ Building ${{ matrix.project }} for ${{ matrix.framework }}"
          dotnet build ${{ matrix.csproj }} --framework ${{ matrix.framework }} --configuration Release

      - name: Pack ${{ matrix.project }}
        run: |
          echo "ğŸ“¦ Packing ${{ matrix.project }}"
          dotnet pack ${{ matrix.csproj }} --configuration Release --output ./artifacts

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project }}-${{ matrix.framework }}-packages
          path: ./artifacts/*.nupkg

  # ğŸ§ª Package Validation
  package-validation:
    runs-on: ubuntu-latest
    needs: [pre-release-validation, build-matrix]
    if: needs.pre-release-validation.outputs.can-release == 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      - name: Validate Package Contents
        run: |
          echo "ğŸ” Validating all package contents..."
          
          for pkg in ./downloaded-artifacts/**/*.nupkg; do
            echo "ğŸ“¦ Validating $pkg"
            
            # Check package structure
            unzip -l "$pkg" | head -20
            
            # Validate required files exist
            if [[ "$pkg" == *"SourceGenerators"* ]]; then
              echo "ğŸ” Checking source generator package..."
              unzip -l "$pkg" | grep -E "(analyzers|content)" || {
                echo "âŒ Missing required files in source generator package"
                exit 1
              }
            fi
            
            echo "âœ… Package validation passed"
          done

      - name: Test Package Installation
        run: |
          echo "ğŸ§ª Testing package installation..."
          
          # Create test project
          mkdir test-install
          cd test-install
          dotnet new webapi -n TestApp
          cd TestApp
          
          # Install packages from artifacts
          for pkg in ../downloaded-artifacts/**/REslava.Result*.nupkg; do
            echo "ğŸ“¦ Installing $(basename $pkg)"
            dotnet add package "$(basename $pkg .nupkg)" --source ../downloaded-artifacts
          done
          
          # Build and test
          dotnet build
          echo "âœ… Package installation test passed"

  # ğŸš€ Staged Release
  staged-release:
    runs-on: ubuntu-latest
    needs: [pre-release-validation, package-validation]
    if: needs.pre-release-validation.outputs.can-release == 'true'
    environment: staging
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      - name: Create Staging Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ needs.pre-release-validation.outputs.version }}-staging"
          name: "Staging Release ${{ needs.pre-release-validation.outputs.version }}"
          body: |
            # ğŸš€ Staging Release ${{ needs.pre-release-validation.outputs.version }}
            
            This is a **staging release** for testing purposes.
            
            ## ğŸ“¦ Packages
            - Core Library: REslava.Result
            - Source Generator: REslava.Result.SourceGenerators
            
            ## ğŸ§ª Testing Status
            - âœ… All tests passed
            - âœ… Package validation completed
            - âœ… Ready for production release
            
            **âš ï¸ This is a staging release. Do not use in production.**
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ¯ Production Release
  production-release:
    runs-on: ubuntu-latest
    needs: [pre-release-validation, package-validation, staged-release]
    if: needs.pre-release-validation.outputs.can-release == 'true'
    environment: production
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      - name: Publish to NuGet
        run: |
          echo "ğŸš€ Publishing packages to NuGet..."
          
          # Publish core packages
          find ./downloaded-artifacts -name "REslava.Result.*.nupkg" -exec dotnet nuget push {} \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate \;
          
          # Publish source generator packages
          find ./downloaded-artifacts -name "REslava.Result.SourceGenerators.*.nupkg" -exec dotnet nuget push {} \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate \;
          
          echo "âœ… All packages published successfully"

      - name: Verify NuGet Publication
        run: |
          echo "ğŸ” Verifying packages are available on NuGet..."
          
          version="${{ needs.pre-release-validation.outputs.version }}"
          
          # Check core package
          curl -f "https://api.nuget.org/v3-flatcontainer/reslava.result/$version/reslava.result.$version.nupkg" || {
            echo "âŒ Core package not found on NuGet"
            exit 1
          }
          
          # Check source generator package
          curl -f "https://api.nuget.org/v3-flatcontainer/reslava.result.sourcegenerators/$version/reslava.result.sourcegenerators.$version.nupkg" || {
            echo "âŒ Source generator package not found on NuGet"
            exit 1
          }
          
          echo "âœ… All packages verified on NuGet"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.pre-release-validation.outputs.version }}
          name: "Release ${{ needs.pre-release-validation.outputs.version }}"
          body_path: GITHUB_RELEASE_${{ needs.pre-release-validation.outputs.version }}.md
          draft: false
          prerelease: false
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (Fallback)
        if: failure()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.pre-release-validation.outputs.version }}
          name: "Release ${{ needs.pre-release-validation.outputs.version }}"
          body: |
            # ğŸš€ REslava.Result.SourceGenerators ${{ needs.pre-release-validation.outputs.version }}
            
            ## ğŸ“¦ Package Information
            - **Core Library**: [REslava.Result v1.9.0](https://www.nuget.org/packages/REslava.Result/1.9.0)
            - **Source Generator**: [REslava.Result.SourceGenerators ${{ needs.pre-release-validation.outputs.version }}](https://www.nuget.org/packages/REslava.Result.SourceGenerators/${{ needs.pre-release-validation.outputs.version }})
            
            ## ğŸš€ Installation
            ```xml
            <PackageReference Include="REslava.Result" Version="1.9.0" />
            <PackageReference Include="REslava.Result.SourceGenerators" Version="${{ needs.pre-release-validation.outputs.version }}" />
            ```
            
            ## âœ… What's Included
            - SOLID architecture source generator
            - HTTP method extensions: ToIResult, ToPostResult, ToPutResult, ToDeleteResult, ToPatchResult
            - Support for .NET 8.0, 9.0, 10.0
            - Comprehensive error handling
            
            ---
            
            ğŸ“– [Documentation](https://github.com/reslava/nuget-package-reslava-result)
            ğŸ› [Issues](https://github.com/reslava/nuget-package-reslava-result/issues)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post-Release Validation
        run: |
          echo "ğŸ§ª Running post-release validation..."
          
          # Create fresh project and test published packages
          mkdir fresh-test
          cd fresh-test
          dotnet new webapi -n FreshTest
          cd FreshTest
          
          # Install published packages
          dotnet add package REslava.Result --version 1.9.0
          dotnet add package REslava.Result.SourceGenerators --version ${{ needs.pre-release-validation.outputs.version }}
          
          # Build and run basic test
          dotnet build
          echo "âœ… Post-release validation completed"

  # ğŸ“¢ Notifications
  notifications:
    runs-on: ubuntu-latest
    needs: [production-release]
    if: always()
    
    steps:
      - name: Notify Success
        if: needs.production-release.result == 'success'
        run: |
          echo "ğŸ‰ Release ${{ needs.pre-release-validation.outputs.version }} completed successfully!"
          echo "ğŸ“¦ Packages available on NuGet.org"
          echo "ğŸ“ Release notes published on GitHub"

      - name: Notify Failure
        if: needs.production-release.result == 'failure'
        run: |
          echo "âŒ Release ${{ needs.pre-release-validation.outputs.version }} failed!"
          echo "ğŸ” Check logs for details"
          exit 1
