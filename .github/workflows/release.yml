name: Simple Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Validate Version
        run: |
          echo "ğŸ” Checking version consistency..."
          gen_version=$(grep -oP '(?<=<GeneratorPackageVersion>)[^<]+' Directory.Build.props)
          tag_version="${{ github.ref_name }}"
          # Remove 'v' prefix from tag version for comparison
          tag_version_clean="${tag_version#v}"
          
          if [[ "$gen_version" == "$tag_version_clean" ]]; then
            echo "âœ… Version $tag_version matches Directory.Build.props"
          else
            echo "âŒ Version mismatch: Directory.Build.props=$gen_version, tag=$tag_version"
            exit 1
          fi

      - name: Build and Pack
        run: |
          echo "ğŸ—ï¸ Building solution..."
          dotnet build --configuration Release
          
          echo "ğŸ“¦ Packing packages..."
          dotnet pack --configuration Release --output ./packages

      - name: Publish to NuGet
        run: |
          echo "ğŸ“¦ Publishing to NuGet..."
          find ./packages -name "*.nupkg" -exec dotnet nuget push {} \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate \;

      - name: Create GitHub Release (with file)
        uses: softprops/action-gh-release@v2
        with:
          body_path: docs/github/GITHUB_RELEASE_${{ github.ref_name }}.md
          draft: false
          prerelease: false
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (Fallback)
        if: failure()
        uses: softprops/action-gh-release@v2
        with:
          body: |
            # ğŸš€ REslava.Result.SourceGenerators ${{ github.ref_name }}
            
            ## ğŸ“¦ Package Information
            - **Core Library**: [REslava.Result v1.9.0](https://www.nuget.org/packages/REslava.Result/1.9.0)
            - **Source Generator**: [REslava.Result.SourceGenerators ${{ github.ref_name }}](https://www.nuget.org/packages/REslava.Result.SourceGenerators/${{ github.ref_name }})
            
            ## ğŸš€ Installation
            ```xml
            <PackageReference Include="REslava.Result" Version="1.9.0" />
            <PackageReference Include="REslava.Result.SourceGenerators" Version="${{ github.ref_name }}" />
            ```
            
            ## âœ… What's Included
            - SOLID architecture source generator
            - HTTP method extensions: ToIResult, ToPostResult, ToPutResult, ToDeleteResult, ToPatchResult
            - Support for .NET 8.0, 9.0, 10.0
            - Comprehensive error handling
            
            ---
            
            ğŸ“– [Documentation](https://github.com/reslava/nuget-package-reslava-result)
            ğŸ› [Issues](https://github.com/reslava/nuget-package-reslava-result/issues)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
