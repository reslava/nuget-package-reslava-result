name: Simple Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Validate Version
        run: |
          echo "üîç Checking version consistency..."
          gen_version=$(grep -oP '(?<=<GeneratorPackageVersion>)[^<]+' Directory.Build.props)
          tag_version="${{ github.ref_name }}"
          # Remove 'v' prefix from tag version for comparison
          tag_version_clean="${tag_version#v}"
          
          if [[ "$gen_version" == "$tag_version_clean" ]]; then
            echo "‚úÖ Version $tag_version matches Directory.Build.props"
          else
            echo "‚ùå Version mismatch: Directory.Build.props=$gen_version, tag=$tag_version"
            exit 1
          fi

      - name: Build and Pack
        run: |
          echo "üèóÔ∏è Building core packages..."
          
          # Build core library only
          echo "üìö Building REslava.Result..."
          dotnet build src/REslava.Result/REslava.Result.csproj --configuration Release
          
          # Build source generators only  
          echo "üîß Building REslava.Result.SourceGenerators..."
          dotnet build src/REslava.Result.SourceGenerator/REslava.Result.SourceGenerators.csproj --configuration Release
          
          echo "üì¶ Packing packages..."
          dotnet pack src/REslava.Result/REslava.Result.csproj --configuration Release --output ./packages
          dotnet pack src/REslava.Result.SourceGenerator/REslava.Result.SourceGenerators.csproj --configuration Release --output ./packages

      - name: Publish to NuGet
        run: |
          echo "üì¶ Publishing to NuGet..."
          # Only publish main packages, not samples
          find ./packages -name "REslava.Result.*.nupkg" -not -name "*.Samples.*" -exec dotnet nuget push {} \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate \;

      - name: Generate Release Notes (if missing)
        run: |
          RELEASE_FILE="docs/github/GITHUB_RELEASE_${{ github.ref_name }}.md"
          if [ ! -f "$RELEASE_FILE" ]; then
            echo "üìù Generating release notes for ${{ github.ref_name }}..."
            
            # Create the release notes file using echo
            echo "# üöÄ REslava.Result ${{ github.ref_name }}" > "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
            echo "> **Railway-Oriented Programming for .NET** - Complete functional programming framework with revolutionary OneOf auto-conversion!" >> "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
            echo "## üì¶ Installation" >> "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
            echo '```bash' >> "$RELEASE_FILE"
            echo "# Core functional programming library (${{ github.ref_name }})" >> "$RELEASE_FILE"
            echo "dotnet add package REslava.Result" >> "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
            echo "# ASP.NET integration + OneOf extensions (${{ github.ref_name }})" >> "$RELEASE_FILE"
            echo "dotnet add package REslava.Result.SourceGenerators" >> "$RELEASE_FILE"
            echo '```' >> "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
            echo "## üìä Package Information" >> "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
            echo "| Package | NuGet Link |" >> "$RELEASE_FILE"
            echo "|---------|------------|" >> "$RELEASE_FILE"
            echo "**REslava.Result** | [üì¶ View on NuGet](https://www.nuget.org/packages/REslava.Result/${{ github.ref_name }}) |" >> "$RELEASE_FILE"
            echo "**REslava.Result.SourceGenerators** | [üì¶ View on NuGet](https://www.nuget.org/packages/REslava.Result.SourceGenerators/${{ github.ref_name }}) |" >> "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
            echo "## üìö Documentation & Resources" >> "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
            echo "- üìñ **[Main Documentation](https://github.com/reslava/nuget-package-reslava-result)**" >> "$RELEASE_FILE"
            echo "- üêõ **[Issue Tracker](https://github.com/reslava/nuget-package-reslava-result/issues)**" >> "$RELEASE_FILE"
            echo "- üí¨ **[Discussions](https://github.com/reslava/nuget-package-reslava-result/discussions)**" >> "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
            echo "---" >> "$RELEASE_FILE"
            echo "**üöÄ Ready to revolutionize your error handling? Install REslava.Result today!**" >> "$RELEASE_FILE"
            
            echo "‚úÖ Release notes generated at $RELEASE_FILE"
            git add "$RELEASE_FILE"
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git commit -m "docs: Auto-generate release notes for ${{ github.ref_name }}" || echo "No changes to commit"
          else
            echo "‚úÖ Release notes already exist at $RELEASE_FILE"
          fi

      - name: Create GitHub Release (with file)
        uses: softprops/action-gh-release@v2
        with:
          body_path: docs/github/GITHUB_RELEASE_${{ github.ref_name }}.md
          draft: false
          prerelease: false
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (Fallback)
        if: failure()
        uses: softprops/action-gh-release@v2
        with:
          body: |
            # üöÄ REslava.Result.SourceGenerators ${{ github.ref_name }}
            
            ## üì¶ Package Information
            - **Core Library**: [REslava.Result ${{ github.ref_name }}](https://www.nuget.org/packages/REslava.Result/${{ github.ref_name }})
            - **Source Generator**: [REslava.Result.SourceGenerators ${{ github.ref_name }}](https://www.nuget.org/packages/REslava.Result.SourceGenerators/${{ github.ref_name }})
            
            ## üöÄ Installation
            ```xml
            <PackageReference Include="REslava.Result" Version="${{ github.ref_name }}" />
            <PackageReference Include="REslava.Result.SourceGenerators" Version="${{ github.ref_name }}" />
            ```
            
            ## ‚úÖ What's Included
            - SOLID architecture source generator
            - HTTP method extensions: ToIResult, ToPostResult, ToPutResult, ToDeleteResult, ToPatchResult
            - Support for .NET 8.0, 9.0, 10.0
            - Comprehensive error handling
            - **NEW**: Intelligent HTTP status mapping for OneOf types
            
            ---
            
            üìñ [Documentation](https://github.com/reslava/nuget-package-reslava-result)
            üêõ [Issues](https://github.com/reslava/nuget-package-reslava-result/issues)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
