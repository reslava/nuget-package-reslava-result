name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-core:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: ['8.0.x', '9.0.x', '10.0.x']
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Restore dependencies
        run: |
          dotnet restore src/REslava.Result.csproj
          dotnet restore SourceGenerator/REslava.Result.SourceGenerators.csproj

      - name: Build all frameworks
        run: |
          dotnet build src/REslava.Result.csproj --configuration Release --no-restore
          dotnet build SourceGenerator/REslava.Result.SourceGenerators.csproj --configuration Release --no-restore

      - name: Build core library for .NET ${{ matrix.dotnet-version }}
        run: |
          echo "ğŸ”¨ Packing REslava.Result for .NET ${{ matrix.dotnet-version }}"
          dotnet pack src/REslava.Result.csproj --configuration Release --no-build --output ./artifacts-${{ matrix.dotnet-version }} --include-symbols -p:GenerateDocumentationFile=true -p:TargetFramework=net${{ matrix.dotnet-version }}.x
          echo "âœ… Core package built for .NET ${{ matrix.dotnet-version }}"

      - name: Upload core artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-packages-${{ matrix.dotnet-version }}
          path: ./artifacts-${{ matrix.dotnet-version }}/*.nupkg
          retention-days: 1

      - name: Upload symbol artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-symbols-${{ matrix.dotnet-version }}
          path: ./artifacts-${{ matrix.dotnet-version }}/*.snupkg
          retention-days: 1

  build-source-generator:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 10.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore source generator dependencies
        run: dotnet restore SourceGenerator/REslava.Result.SourceGenerators.csproj

      - name: Build source generator
        run: dotnet build SourceGenerator/REslava.Result.SourceGenerators.csproj --configuration Release --no-restore

      - name: Pack source generator
        run: |
          echo "ğŸ”¨ Packing REslava.Result.SourceGenerators"
          dotnet pack SourceGenerator/REslava.Result.SourceGenerators.csproj --configuration Release --no-build --output ./artifacts-source-generator --include-symbols -p:GenerateDocumentationFile=true
          echo "âœ… Source generator package built"

      - name: Upload source generator artifacts
        uses: actions/upload-artifact@v4
        with:
          name: source-generator-packages
          path: ./artifacts-source-generator/*.nupkg
          retention-days: 1

      - name: Upload source generator symbols
        uses: actions/upload-artifact@v4
        with:
          name: source-generator-symbols
          path: ./artifacts-source-generator/*.snupkg
          retention-days: 1

  publish:
    needs: [build-core, build-source-generator]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts

      - name: Push to NuGet
        run: |
          echo "ğŸ“¦ Publishing REslava.Result v1.7.3 to NuGet..."
          
          # Publish core packages for all .NET versions
          find ./downloaded-artifacts -name "REslava.Result.*.nupkg" -exec dotnet nuget push {} --api-key ${{secrets.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json --skip-duplicate \;
          
          # Publish source generator packages
          find ./downloaded-artifacts -name "REslava.Result.SourceGenerators.*.nupkg" -exec dotnet nuget push {} --api-key ${{secrets.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json --skip-duplicate \;
          
          # Publish symbol packages
          find ./downloaded-artifacts -name "*.snupkg" -exec dotnet nuget push {} --api-key ${{secrets.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json --skip-duplicate \;
          
          echo "âœ… All packages published successfully!"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## ğŸ‰ REslava.Result v1.7.3 - Source Generator Release!
            
            ### ğŸš€ MAJOR BREAKTHROUGH: Production-Ready Source Generator
            - **âœ… Zero Boilerplate Code** - Automatic Result<T> to HTTP response conversion
            - **âœ… Generated Extension Methods** - `ToIResult()`, `ToPostResult()`, `ToPutResult()`, etc.
            - **âœ… Smart Error Classification** - Automatic HTTP status codes (400, 404, 422, etc.)
            - **âœ… Minimal API Support** - Perfect for .NET 10 Minimal APIs
            - **âœ… RFC 7807 Compliance** - Standardized ProblemDetails responses
            - **âœ… AOT Compatible** - Works with NativeAOT and trimming
            - **âœ… Zero Runtime Overhead** - Compile-time generation
            
            ### ğŸ¯ What This Means for Developers
            **Before (Manual):** 20+ lines of boilerplate per endpoint
            **After (Source Generator):** 1-2 lines of clean, declarative code
            
            ### ğŸ“¦ Dual Package Release
            ğŸ“¦ [REslava.Result](https://www.nuget.org/packages/REslava.Result) - Core library with HTTP extensions
            ğŸ“¦ [REslava.Result.SourceGenerators](https://www.nuget.org/packages/REslava.Result.SourceGenerators) - Source generator for zero boilerplate
            
            ### ğŸš€ Quick Start
            ```bash
            dotnet add package REslava.Result
            dotnet add package REslava.Result.SourceGenerators
            ```
            
            ### âœ¨ Magic Setup
            ```csharp
            // Add to Program.cs
            using REslava.Result.SourceGenerators;
            [assembly: GenerateResultExtensions]
            
            // Your endpoints become this simple:
            app.MapGet("/api/products/{id}", async (int id, ProductService service) =>
            {
                return await service.GetProductAsync(id)
                    .Map(p => new ProductDto(p))
                    .ToIResult(); // ğŸ¯ GENERATED: Auto HTTP response!
            });
            ```
            
            ### ğŸ¯ Generated Extension Methods
            | Method | HTTP Status | Use Case |
            |--------|-------------|----------|
            | `ToIResult()` | 200/400/404/500 | General operations |
            | `ToPostResult()` | 201 Created | Resource creation |
            | `ToPutResult()` | 200 OK | Resource updates |
            | `ToDeleteResult()` | 200 OK | Resource deletion |
            | `ToPatchResult()` | 200 OK | Partial updates |
            
            ### ï¿½ Smart Error Classification
            - "not found" â†’ 404 Not Found
            - "validation" â†’ 422 Unprocessable Entity  
            - "unauthorized" â†’ 401 Unauthorized
            - "forbidden" â†’ 403 Forbidden
            - "conflict" â†’ 409 Conflict
            - Default â†’ 500 Internal Server Error
            
            ### ğŸŒ ASP.NET Integration Samples
            ğŸš€ **[Compare Pure .NET 10 vs REslava.Result](samples/ASP.NET/README.md)**
            - **MinimalApi.Net10.Reference** - Pure .NET 10 implementation
            - **MinimalApi.Net10.REslava.Result.v1.7.3** - Source generator magic
            
            ### ğŸ“š Complete Documentation
            - ğŸ“– [Getting Started Guide](docs/guide/getting-started.md)
            - ğŸš€ [Source Generator Guide](docs/guide/source-generator.md)
            - ğŸŒ [ASP.NET Integration Samples](samples/ASP.NET/README.md)
            
            ### Framework Support
            - âœ… .NET 8.0
            - âœ… .NET 9.0  
            - âœ… .NET 10.0
            
            ### ğŸ‰ Real-World Impact
            - **70-90% Code Reduction** in API endpoints
            - **Zero Manual Error Handling** - Automatic HTTP responses
            - **Type-Safe Development** - Compile-time error detection
            - **Consistent APIs** - Standardized response format
            
            **This is the biggest leap forward in clean API development for .NET!** ğŸš€
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
