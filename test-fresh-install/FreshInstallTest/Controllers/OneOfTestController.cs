using Microsoft.AspNetCore.Mvc;
using REslava.Result.AdvancedPatterns;
using Generated.OneOfExtensions; // Generated by OneOfToIResult generators

namespace FreshInstallTest.Controllers;

[ApiController]
[Route("api/[controller]")]
public class OneOfTestController : ControllerBase
{
    // Test OneOf<T1, T2> auto-conversion
    [HttpGet("user/{id}")]
    public IResult GetUser(int id)
    {
        if (id <= 0)
        {
            var result = OneOf<Error, User>.FromT1(new ValidationError("Invalid ID"));
            return result.ToIResult(); // Should return 400
        }
        
        if (id == 999)
        {
            var result = OneOf<Error, User>.FromT1(new UserNotFoundError($"User {id} not found"));
            return result.ToIResult(); // Should return 404
        }
        
        var user = new User(id, $"TestUser{id}");
        var successResult = OneOf<Error, User>.FromT2(user);
        return successResult.ToIResult(); // Should return 200
    }
    
    // Test OneOf<T1, T2, T3> auto-conversion
    [HttpPost("user")]
    public IResult CreateUser([FromBody] CreateUserRequest request)
    {
        if (string.IsNullOrEmpty(request.Name))
        {
            var result = OneOf<Error, Error, User>.FromT1(new ValidationError("Name is required"));
            return result.ToIResult(); // Should return 400
        }
            
        if (request.Name.Length < 3)
        {
            var result = OneOf<Error, Error, User>.FromT1(new ValidationError("Name must be at least 3 characters"));
            return result.ToIResult(); // Should return 400
        }
        
        if (request.Email == "admin@company.com")
        {
            var result = OneOf<Error, Error, User>.FromT2(new ConflictError("Admin account already exists"));
            return result.ToIResult(); // Should return 409
        }
        
        var user = new User(1, request.Name);
        var successResult = OneOf<Error, Error, User>.FromT3(user);
        return successResult.ToIResult(); // Should return 201
    }
}

// Test Models
public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    
    public User(int id, string name)
    {
        Id = id;
        Name = name;
    }
}

public class CreateUserRequest
{
    public string Name { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
}

// Test Error Types
public class ValidationError : Error
{
    public ValidationError(string message) : base(message) { }
}

public class UserNotFoundError : Error
{
    public UserNotFoundError(string message) : base(message) { }
}

public class ConflictError : Error
{
    public ConflictError(string message) : base(message) { }
}

public class SystemError : Error
{
    public SystemError(string message) : base(message) { }
}

// Base Error class (minimal implementation for testing)
public abstract class Error
{
    public string Message { get; }
    
    protected Error(string message)
    {
        Message = message;
    }
}
