using System;
using System.Text;

namespace REslava.Result.SourceGenerators.Core.CodeGeneration
{
    /// <summary>
    /// Fluent builder for generating C# source code with proper indentation and formatting.
    /// Wraps StringBuilder with helper methods for common code generation patterns.
    /// </summary>
    public class CodeBuilder
    {
        private readonly StringBuilder _sb;
        private int _indentLevel;
        private readonly string _indentString;
        private bool _lineStarted;

        public CodeBuilder(string indentString = "    ")
        {
            _sb = new StringBuilder();
            _indentString = indentString;
            _indentLevel = 0;
            _lineStarted = false;
        }

        /// <summary>
        /// Gets the current indentation level (0-based).
        /// </summary>
        public int IndentLevel => _indentLevel;

        /// <summary>
        /// Increases the indentation level.
        /// </summary>
        public CodeBuilder Indent()
        {
            _indentLevel++;
            return this;
        }

        /// <summary>
        /// Decreases the indentation level.
        /// </summary>
        public CodeBuilder Unindent()
        {
            if (_indentLevel > 0)
                _indentLevel--;
            return this;
        }

        /// <summary>
        /// Appends a line of code with proper indentation.
        /// </summary>
        public CodeBuilder AppendLine(string line = "")
        {
            if (!string.IsNullOrEmpty(line))
            {
                AppendIndentation();
                _sb.Append(line);
            }
            _sb.AppendLine();
            _lineStarted = false;
            return this;
        }

        /// <summary>
        /// Appends text without a newline (respects current indentation if at line start).
        /// </summary>
        public CodeBuilder Append(string text)
        {
            if (!_lineStarted && !string.IsNullOrEmpty(text))
            {
                AppendIndentation();
                _lineStarted = true;
            }
            _sb.Append(text);
            return this;
        }

        /// <summary>
        /// Appends an opening brace and increases indentation.
        /// </summary>
        public CodeBuilder OpenBrace(string? prefix = null)
        {
            if (prefix != null)
                AppendLine(prefix);
            AppendLine("{");
            Indent();
            return this;
        }

        /// <summary>
        /// Decreases indentation and appends a closing brace.
        /// </summary>
        public CodeBuilder CloseBrace(string? suffix = null)
        {
            Unindent();
            if (suffix != null)
                AppendLine("}" + suffix);
            else
                AppendLine("}");
            return this;
        }

        /// <summary>
        /// Appends a blank line.
        /// </summary>
        public CodeBuilder BlankLine()
        {
            _sb.AppendLine();
            _lineStarted = false;
            return this;
        }

        /// <summary>
        /// Appends a file header comment block.
        /// </summary>
        public CodeBuilder AppendFileHeader(string generatorName, params string[] additionalInfo)
        {
            AppendLine("// <auto-generated/>");
            AppendLine($"// This file was automatically generated by {generatorName}");
            AppendLine($"// Generated on: {DateTime.UtcNow:yyyy-MM-dd HH:mm:ss} UTC");
            
            if (additionalInfo.Length > 0)
            {
                AppendLine("//");
                foreach (var info in additionalInfo)
                {
                    AppendLine($"// {info}");
                }
            }
            
            BlankLine();
            AppendLine("#nullable enable");
            BlankLine();
            return this;
        }

        /// <summary>
        /// Appends using directives.
        /// </summary>
        public CodeBuilder AppendUsings(params string[] namespaces)
        {
            foreach (var ns in namespaces)
            {
                AppendLine($"using {ns};");
            }
            BlankLine();
            return this;
        }

        /// <summary>
        /// Appends a namespace declaration and opens the brace.
        /// </summary>
        public CodeBuilder AppendNamespace(string namespaceName)
        {
            AppendLine($"namespace {namespaceName}");
            OpenBrace();
            return this;
        }

        /// <summary>
        /// Closes the namespace (unindents and closes brace).
        /// </summary>
        public CodeBuilder CloseNamespace()
        {
            CloseBrace();
            return this;
        }

        /// <summary>
        /// Appends an XML documentation comment (summary).
        /// </summary>
        public CodeBuilder AppendXmlSummary(string summary)
        {
            AppendLine("/// <summary>");
            foreach (var line in summary.Split(new[] { '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries))
            {
                AppendLine($"/// {line.Trim()}");
            }
            AppendLine("/// </summary>");
            return this;
        }

        /// <summary>
        /// Appends an XML documentation comment (param).
        /// </summary>
        public CodeBuilder AppendXmlParam(string name, string description)
        {
            AppendLine($"/// <param name=\"{name}\">{description}</param>");
            return this;
        }

        /// <summary>
        /// Appends an XML documentation comment (returns).
        /// </summary>
        public CodeBuilder AppendXmlReturns(string description)
        {
            AppendLine($"/// <returns>{description}</returns>");
            return this;
        }

        /// <summary>
        /// Appends a class declaration and opens the brace.
        /// </summary>
        public CodeBuilder AppendClassDeclaration(string className, params string[] modifiers)
        {
            var modifierString = modifiers.Length > 0 ? string.Join(" ", modifiers) + " " : "public ";
            AppendLine($"{modifierString}class {className}");
            OpenBrace();
            return this;
        }

        /// <summary>
        /// Appends a method declaration and opens the brace.
        /// </summary>
        public CodeBuilder AppendMethodDeclaration(
            string methodName, 
            string returnType, 
            string parameters,
            string? genericTypeParameter = null,
            params string[] modifiers)
        {
            var modifierString = modifiers.Length > 0 ? string.Join(" ", modifiers) + " " : "public ";
            var genericString = genericTypeParameter != null ? $"<{genericTypeParameter}>" : "";
            AppendLine($"{modifierString}{returnType} {methodName}{genericString}({parameters})");
            OpenBrace();
            return this;
        }

        /// <summary>
        /// Appends a property declaration.
        /// </summary>
        public CodeBuilder AppendProperty(
            string propertyName,
            string type,
            string? initializer = null,
            params string[] modifiers)
        {
            var modifierString = modifiers.Length > 0 ? string.Join(" ", modifiers) + " " : "public ";
            var initString = initializer != null ? $" = {initializer};" : " { get; set; }";
            AppendLine($"{modifierString}{type} {propertyName}{initString}");
            return this;
        }

        /// <summary>
        /// Executes an action at the current indentation level.
        /// Useful for nested code generation.
        /// </summary>
        public CodeBuilder WithIndent(Action<CodeBuilder> action)
        {
            Indent();
            action(this);
            Unindent();
            return this;
        }

        /// <summary>
        /// Returns the generated code as a string.
        /// </summary>
        public override string ToString()
        {
            return _sb.ToString();
        }

        /// <summary>
        /// Clears all content from the builder.
        /// </summary>
        public CodeBuilder Clear()
        {
            _sb.Clear();
            _indentLevel = 0;
            _lineStarted = false;
            return this;
        }

        private void AppendIndentation()
        {
            for (int i = 0; i < _indentLevel; i++)
            {
                _sb.Append(_indentString);
            }
        }
    }
}
