using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using REslava.Result.SourceGenerators.Core.Interfaces;
using System.Text;

namespace REslava.Result.SourceGenerators.Generators.ResultToActionResult.CodeGeneration
{
    /// <summary>
    /// Generates ResultToActionResult extension methods for ASP.NET MVC IActionResult.
    /// Mirrors ResultToIResultExtensionGenerator but targets MVC result types.
    /// </summary>
    public class ResultToActionResultExtensionGenerator : ICodeGenerator
    {
        public SourceText GenerateCode(Compilation compilation, object config)
        {
            var builder = new StringBuilder();

            // Add nullable enable for generated code
            builder.AppendLine("#nullable enable");
            builder.AppendLine();

            // Add using statements
            builder.AppendLine("using Microsoft.AspNetCore.Mvc;");
            builder.AppendLine("using REslava.Result;");
            builder.AppendLine("using System;");
            builder.AppendLine("using System.Collections.Generic;");
            builder.AppendLine("using System.Linq;");
            builder.AppendLine();

            // Generate the class and methods
            builder.AppendLine("namespace Generated.ActionResultExtensions");
            builder.AppendLine("{");
            builder.AppendLine("    /// <summary>");
            builder.AppendLine("    /// Extension methods for converting Result&lt;T&gt; to IActionResult.");
            builder.AppendLine("    /// Generated by REslava.Result.SourceGenerators.");
            builder.AppendLine("    /// </summary>");
            builder.AppendLine("    public static class ResultToActionResultExtensions");
            builder.AppendLine("    {");

            // ToActionResult (convention-based)
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to an IActionResult for ASP.NET MVC responses.");
            builder.AppendLine("        /// Uses convention-based mapping: reads HttpStatusCode tag from domain errors.");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IActionResult ToActionResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("                return new OkObjectResult(result.Value);");
            builder.AppendLine();
            builder.AppendLine("            return MapErrorToActionResult(result.Errors);");
            builder.AppendLine("        }");
            builder.AppendLine();

            // ToActionResult (explicit overload — escape hatch)
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to an IActionResult using explicit mapping functions.");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IActionResult ToActionResult<T>(");
            builder.AppendLine("            this Result<T> result,");
            builder.AppendLine("            Func<T, IActionResult> onSuccess,");
            builder.AppendLine("            Func<IReadOnlyList<IError>, IActionResult> onFailure)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("                return onSuccess(result.Value);");
            builder.AppendLine();
            builder.AppendLine("            return onFailure(result.Errors);");
            builder.AppendLine("        }");
            builder.AppendLine();

            // ToPostActionResult
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to a POST action result (201 Created).");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IActionResult ToPostActionResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("                return new CreatedResult((string?)null, result.Value);");
            builder.AppendLine();
            builder.AppendLine("            return MapErrorToActionResult(result.Errors);");
            builder.AppendLine("        }");
            builder.AppendLine();

            // ToPutActionResult
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to a PUT action result (200 OK).");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IActionResult ToPutActionResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("                return new OkObjectResult(result.Value);");
            builder.AppendLine();
            builder.AppendLine("            return MapErrorToActionResult(result.Errors);");
            builder.AppendLine("        }");
            builder.AppendLine();

            // ToPatchActionResult
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to a PATCH action result (200 OK).");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IActionResult ToPatchActionResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("                return new OkObjectResult(result.Value);");
            builder.AppendLine();
            builder.AppendLine("            return MapErrorToActionResult(result.Errors);");
            builder.AppendLine("        }");
            builder.AppendLine();

            // ToDeleteActionResult
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts a Result&lt;T&gt; to a DELETE action result (204 No Content).");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IActionResult ToDeleteActionResult<T>(this Result<T> result)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (result.IsSuccess)");
            builder.AppendLine("                return new NoContentResult();");
            builder.AppendLine();
            builder.AppendLine("            return MapErrorToActionResult(result.Errors);");
            builder.AppendLine("        }");
            builder.AppendLine();

            // Shared helper — reads HttpStatusCode tag from domain errors
            builder.AppendLine("        private static IActionResult MapErrorToActionResult(IReadOnlyList<IError> errors)");
            builder.AppendLine("        {");
            builder.AppendLine("            var firstError = errors.FirstOrDefault();");
            builder.AppendLine("            var errorMessage = firstError?.Message ?? \"Unknown error\";");
            builder.AppendLine();
            builder.AppendLine("            var statusCode = 400;");
            builder.AppendLine("            if (firstError?.Tags != null)");
            builder.AppendLine("            {");
            builder.AppendLine("                if (firstError.Tags.TryGetValue(\"HttpStatusCode\", out var code) && code is int sc)");
            builder.AppendLine("                    statusCode = sc;");
            builder.AppendLine("                else if (firstError.Tags.TryGetValue(\"StatusCode\", out var code2) && code2 is int sc2)");
            builder.AppendLine("                    statusCode = sc2;");
            builder.AppendLine("            }");
            builder.AppendLine();
            builder.AppendLine("            return statusCode switch");
            builder.AppendLine("            {");
            builder.AppendLine("                401 => new UnauthorizedResult(),");
            builder.AppendLine("                403 => new ForbidResult(),");
            builder.AppendLine("                404 => new NotFoundObjectResult(errorMessage),");
            builder.AppendLine("                409 => new ConflictObjectResult(errorMessage),");
            builder.AppendLine("                _ => new ObjectResult(new { Detail = errorMessage }) { StatusCode = statusCode }");
            builder.AppendLine("            };");
            builder.AppendLine("        }");

            builder.AppendLine("    }");
            builder.AppendLine("}");

            return SourceText.From(builder.ToString(), Encoding.UTF8);
        }
    }
}
