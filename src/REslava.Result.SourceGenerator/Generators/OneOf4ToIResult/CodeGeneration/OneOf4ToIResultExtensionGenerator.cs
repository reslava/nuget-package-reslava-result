using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using REslava.Result.SourceGenerators.Core.Interfaces;
using System.Text;

namespace REslava.Result.SourceGenerators.Generators.OneOf4ToIResult.CodeGeneration
{
    /// <summary>
    /// Generates OneOf4ToIResult extension methods.
    /// Single Responsibility: Only generates the main extension methods.
    /// </summary>
    public class OneOf4ToIResultExtensionGenerator : ICodeGenerator
    {
        public SourceText GenerateCode(Compilation compilation, object config)
        {
            System.Diagnostics.Debug.WriteLine("ðŸ”¥ OneOf4ToIResultExtensionGenerator.GenerateCode called!");
            
            var builder = new StringBuilder();
            
            // Add using statements
            builder.AppendLine("using Microsoft.AspNetCore.Http;");
            builder.AppendLine("using REslava.Result.AdvancedPatterns;");
            builder.AppendLine("using System;");
            builder.AppendLine("using System.Linq;");
            builder.AppendLine("using Generated.OneOfExtensions;");
            builder.AppendLine();
            
            // Generate the class and methods
            builder.AppendLine("namespace Generated.OneOfExtensions");
            builder.AppendLine("{");
            builder.AppendLine("    /// <summary>");
            builder.AppendLine("    /// Extension methods for converting OneOf&lt;T1,T2,T3,T4&gt; to IResult.");
            builder.AppendLine("    /// Generated by REslava.Result.SourceGenerators.");
            builder.AppendLine("    /// </summary>");
            builder.AppendLine("    public static class OneOf4Extensions");
            builder.AppendLine("    {");
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Converts OneOf&lt;T1,T2,T3,T4&gt; to IResult with intelligent HTTP mapping.");
            builder.AppendLine("        /// Automatically detects error types and maps to appropriate HTTP status codes.");
            builder.AppendLine("        /// Error types â†’ 400/401/403/404/409/500, Success types â†’ 200/201");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        public static IResult ToIResult(this OneOf<T1, T2, T3, T4> oneOf)");
            builder.AppendLine("        {");
            builder.AppendLine("            return oneOf.Match(");
            builder.AppendLine("                t1 => IsErrorType(typeof(T1)) ? MapErrorToHttpResult(t1, typeof(T1)) : Results.Ok(t1),");
            builder.AppendLine("                t2 => IsErrorType(typeof(T2)) ? MapErrorToHttpResult(t2, typeof(T2)) : Results.Ok(t2),");
            builder.AppendLine("                t3 => IsErrorType(typeof(T3)) ? MapErrorToHttpResult(t3, typeof(T3)) : Results.Ok(t3),");
            builder.AppendLine("                t4 => IsErrorType(typeof(T4)) ? MapErrorToHttpResult(t4, typeof(T4)) : Results.Ok(t4)");
            builder.AppendLine("            );");
            builder.AppendLine("        }");
            builder.AppendLine();
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Maps an error object to appropriate HTTP result using intelligent detection.");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        private static IResult MapErrorToHttpResult(object error, Type errorType)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (error == null)");
            builder.AppendLine("                return Results.Problem(\"Unknown error\", statusCode: 500);");
            builder.AppendLine("            ");
            builder.AppendLine("            var typeName = errorType.Name;");
            builder.AppendLine("            ");
            builder.AppendLine("            // Validation Errors â†’ 400 Bad Request");
            builder.AppendLine("            if (typeName.Contains(\"ValidationError\") || typeName.Contains(\"Invalid\"))");
            builder.AppendLine("                return Results.BadRequest(error?.ToString() ?? \"Validation error\");");
            builder.AppendLine("                ");
            builder.AppendLine("            // Not Found Errors â†’ 404 Not Found");
            builder.AppendLine("            if (typeName.Contains(\"NotFound\") || typeName.Contains(\"Missing\"))");
            builder.AppendLine("                return Results.NotFound(error?.ToString() ?? \"Resource not found\");");
            builder.AppendLine("                ");
            builder.AppendLine("            // Conflict Errors â†’ 409 Conflict");
            builder.AppendLine("            if (typeName.Contains(\"Conflict\") || typeName.Contains(\"Duplicate\"))");
            builder.AppendLine("                return Results.Conflict(error?.ToString() ?? \"Resource conflict\");");
            builder.AppendLine("                ");
            builder.AppendLine("            // Authorization Errors â†’ 401 Unauthorized");
            builder.AppendLine("            if (typeName.Contains(\"Unauthorized\") || typeName.Contains(\"Authentication\"))");
            builder.AppendLine("                return Results.Unauthorized();");
            builder.AppendLine("                ");
            builder.AppendLine("            // Forbidden Errors â†’ 403 Forbidden");
            builder.AppendLine("            if (typeName.Contains(\"Forbidden\") || typeName.Contains(\"Permission\"))");
            builder.AppendLine("                return Results.Forbid();");
            builder.AppendLine("                ");
            builder.AppendLine("            // Server Errors â†’ 500 Internal Server Error");
            builder.AppendLine("            if (typeName.Contains(\"Database\") || typeName.Contains(\"System\") || typeName.Contains(\"Infrastructure\"))");
            builder.AppendLine("                return Results.Problem(detail: error?.ToString() ?? \"Server error\", statusCode: 500);");
            builder.AppendLine("                ");
            builder.AppendLine("            // Default to 400 for unknown error types");
            builder.AppendLine("            return Results.BadRequest(error?.ToString() ?? \"Error\");");
            builder.AppendLine("        }");
            builder.AppendLine();
            builder.AppendLine("        /// <summary>");
            builder.AppendLine("        /// Checks if a type is likely an error type for intelligent HTTP mapping.");
            builder.AppendLine("        /// </summary>");
            builder.AppendLine("        private static bool IsErrorType(Type type)");
            builder.AppendLine("        {");
            builder.AppendLine("            if (type == null) return false;");
            builder.AppendLine("            ");
            builder.AppendLine("            try");
            builder.AppendLine("            {");
            builder.AppendLine("                if (type.BaseType != null && type.BaseType.Name == \"Error\")");
            builder.AppendLine("                    return true;");
            builder.AppendLine("            }");
            builder.AppendLine("            catch");
            builder.AppendLine("            {");
            builder.AppendLine("                // Ignore reflection errors in source generator context");
            builder.AppendLine("            }");
            builder.AppendLine("            ");
            builder.AppendLine("            // Check naming patterns");
            builder.AppendLine("            var typeName = type.Name.ToLowerInvariant();");
            builder.AppendLine("            return typeName.Contains(\"error\") || ");
            builder.AppendLine("                   typeName.Contains(\"exception\") || ");
            builder.AppendLine("                   typeName.Contains(\"fault\") ||");
            builder.AppendLine("                   typeName.Contains(\"failure\");");
            builder.AppendLine("        }");
            builder.AppendLine("    }");
            builder.AppendLine("}");
            
            var result = SourceText.From(builder.ToString(), Encoding.UTF8);
            System.Diagnostics.Debug.WriteLine("ðŸ”¥ OneOf4ToIResultExtensionGenerator.GenerateCode completed!");
            return result;
        }
    }
}
