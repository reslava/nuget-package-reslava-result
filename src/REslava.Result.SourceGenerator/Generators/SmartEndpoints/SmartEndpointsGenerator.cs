using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using System.Text;

namespace REslava.Result.SourceGenerators.Generators.SmartEndpoints
{
    /// <summary>
    /// SmartEndpoints generator - generates ASP.NET Core Minimal API endpoints
    /// </summary>
    [Generator]
    public class SmartEndpointsGenerator : IIncrementalGenerator
    {
        public SmartEndpointsGenerator()
        {
            System.Diagnostics.Debug.WriteLine("ðŸš€ SmartEndpointsGenerator CONSTRUCTOR called!");
        }

        public void Initialize(IncrementalGeneratorInitializationContext context)
        {
            System.Diagnostics.Debug.WriteLine("ðŸš€ SmartEndpointsGenerator.Initialize called!");
            
            // Generate AutoGenerateEndpointsAttribute
            context.RegisterSourceOutput(context.CompilationProvider, (spc, compilation) =>
            {
                var attributeCode = GenerateAutoGenerateEndpointsAttribute();
                spc.AddSource("AutoGenerateEndpointsAttribute.g.cs", SourceText.From(attributeCode, Encoding.UTF8));
            });
            
            // Generate AutoMapEndpointAttribute
            context.RegisterSourceOutput(context.CompilationProvider, (spc, compilation) =>
            {
                var attributeCode = GenerateAutoMapEndpointAttribute();
                spc.AddSource("AutoMapEndpointAttribute.g.cs", SourceText.From(attributeCode, Encoding.UTF8));
            });
            
            // Generate SmartEndpointExtensions
            context.RegisterSourceOutput(context.CompilationProvider, (spc, compilation) =>
            {
                var extensionCode = GenerateSmartEndpointExtensions();
                spc.AddSource("SmartEndpointExtensions.g.cs", SourceText.From(extensionCode, Encoding.UTF8));
            });
        }

        private string GenerateAutoGenerateEndpointsAttribute()
        {
            return @"#nullable enable
using System;

namespace Generated.SmartEndpoints
{
    /// <summary>
    /// Attribute to mark classes for automatic endpoint generation.
    /// </summary>
    [AttributeUsage(AttributeTargets.Class)]
    public class AutoGenerateEndpointsAttribute : Attribute
    {
        /// <summary>
        /// Optional route prefix for generated endpoints.
        /// </summary>
        public string? RoutePrefix { get; set; }

        /// <summary>
        /// Initializes a new instance of AutoGenerateEndpointsAttribute.
        /// </summary>
        /// <param name=""routePrefix"">Optional route prefix.</param>
        public AutoGenerateEndpointsAttribute(string? routePrefix = null)
        {
            RoutePrefix = routePrefix;
        }
    }
}";
        }

        private string GenerateAutoMapEndpointAttribute()
        {
            return @"#nullable enable
using System;

namespace Generated.SmartEndpoints
{
    /// <summary>
    /// Attribute to explicitly map endpoints to specific routes and HTTP methods.
    /// </summary>
    [AttributeUsage(AttributeTargets.Method)]
    public class AutoMapEndpointAttribute : Attribute
    {
        /// <summary>
        /// The HTTP method for this endpoint.
        /// </summary>
        public string? HttpMethod { get; set; }

        /// <summary>
        /// The route template for this endpoint.
        /// </summary>
        public string? Route { get; set; }

        /// <summary>
        /// Initializes a new instance of AutoMapEndpointAttribute.
        /// </summary>
        /// <param name=""httpMethod"">HTTP method (GET, POST, PUT, DELETE, etc.).</param>
        /// <param name=""route"">Route template.</param>
        public AutoMapEndpointAttribute(string? httpMethod = null, string? route = null)
        {
            HttpMethod = httpMethod;
            Route = route;
        }
    }
}";
        }

        private string GenerateSmartEndpointExtensions()
        {
            return @"#nullable enable
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Routing;
using REslava.Result;
using REslava.Result.AdvancedPatterns;
using MinimalApi.Net10.REslavaResult.Models;
using Generated.OneOfExtensions;
using System;
using System.Threading.Tasks;

namespace Generated.SmartEndpoints
{
    /// <summary>
    /// Auto-generated endpoint registration extensions.
    /// Generated by REslava.Result.SourceGenerators.SmartEndpoints.
    /// </summary>
    public static class SmartEndpointExtensions
    {
        /// <summary>
        /// Maps all auto-discovered SmartEndpoints to the application.
        /// </summary>
        public static IEndpointRouteBuilder MapSmartEndpoints(this IEndpointRouteBuilder endpoints)
        {
            // DEBUG: SmartEndpoints registration started
            endpoints.MapGet(""/api/simple/test"", () => Results.Ok(""Simple test works - SmartEndpoints active!""));
            
            return endpoints;
        }
    }
}";
        }
    }
}
